# CSAPP

- [1. 汇编](#1-汇编)
- [2. 栈](#2-栈)
- [3. 存储器](#3-存储器)
- [4. 构建过程](#4-构建过程)
- [5. ELF](#5-elf)
- [6. 静态链接](#6-静态链接)

`man ascii` 生成 ascii 表

## 1. 汇编

点开头的都是指导汇编器和链接器的伪命令

寄存器：

- `%rip` 程序计数器 PC，指向下一条指令
- 一般有 16 个通用寄存器，`%al %ax %eax %rax` 分别是 8, 16, 32, 64 位，`%r8b %r8w %r8d %r8` 同理
  - `%rax` 返回值
  - `%rbx` 调用函数前后需保证不变
  - `%rcx` 第 4 个参数
  - `%rdx` 第 3 个参数
  - `%rsi` 第 2 个参数
  - `%rdi` 第 1 个参数
  - `%rbp` 调用函数前后需保证不变，帧指针
  - `%rsp` 栈指针
  - `%r8` 第 5 个参数
  - `%r9` 第 6 个参数
  - `%r10` 随意修改
  - `%r11` 随意修改
  - `%r12` 调用函数前后需保证不变
  - `%r13` 调用函数前后需保证不变
  - `%r14` 调用函数前后需保证不变
  - `%r15` 调用函数前后需保证不变
- 段寄存器？
- 标志寄存器

操作数

- `$0x123` 立即数
- `0x123` 绝对寻址
- `(%rax, %rcx)` a + c
- `9(%rax, %rcx)` a + c + 9
- `(%rax, %rcx, 4)` a + c * 4
- `9(%rax, %rcx, 4)` a + c * 4 + 9

指令后缀：`b w l q` 分别是 8, 16, 32, 64 位

一些指令

- `movq a, b`：`b = a`
  - movl 会把目的寄存器的高 4 字节置 0
- `pushq x`：`rsp -= 8, *rsp = x`
- `popq x`：`x = *rsp, rsp += 8`
- sar 有符号右移，shr 无符合右移

## 2. 栈

缓冲区溢出攻击：外部向 char 数组写数据时，溢出并覆盖函数返回地址，可以执行任意代码

对抗缓冲区溢出攻击：

- 栈随机化：程序一开始会在栈上分配随机大小的空间，是标准行为。该防御不是完全安全的。
- 栈破坏检测：在函数中有 char 局部数组时，保存函数返回地址，并在调用后比较
- 限制可执行代码区域：栈被标记为可读可写不可执行

## 3. 存储器

层次结构

- L0 寄存器 0 个周期
- L1 高速缓存 SRAM 4 个周期
- L2 高速缓存 SRAM 10 个周期
- L3 高速缓存 SRAM 50 个周期
- L4 主存 DRAM 上百个周期
- L5 二级存储 磁盘 几千万个周期

一个空的缓存称为冷缓存，对冷缓存的不命中称为冷不命中

发生不命中就会执行放置策略

## 4. 构建过程

- 预处理器（cpp）
- 编译器（ccl）
- 汇编器（as）
- 链接器（ld）

## 5. ELF

ELF 分类

- 可重定位文件 relocatable file
- 可执行文件 executable file
- 共享目标文件 shared object file
- 核心转储文件 core dump file

ELF 构成

- ELF 头 ELF header
- .text 代码段
- .data 数据段
- .rodata 只读数据
- .bss bss 段，存未初始化的静态变量，在文件中不占空间
- .symtab 符号表
- .rel.text 重定位到 .text
- .rel.data 重定位到 .data
- .debug 调试符号表，需要 -g 编译
- .line 行号，需要 -g 编译
- .strtab 字符串表

符号

- 本模块定义的全局符号，比如非静态函数和非静态全局变量
- 被本模块引用的全局符号（外部符号）
- 局部符号，比如静态函数和静态全局变量

.symtab 节

```cpp
typedef struct { 
    int name; // 字符串索引
    char type: 4, // 函数还是数据
         binding: 4; // 局部还是全局
    char reserved;
    short section; // 到节头表的索引
    long value; // 目标地址
    long size; // 目标大小
} Elf64_Syrnbol;
```

## 6. 静态链接

重名符号：

1. 不允许多个重名的强符号
2. 优先强符号
3. 弱符号里选择任意一个

静态库：多个目标文件的打包

- `ar rcs xxx.a xxx.o xxx.o ...`
- `gcc -static -o main main.o ./xxx.a`

libc.a 提供标准 IO、字符串等操作

libm.a 提供浮点数学函数

静态库以存档 archive 的文件格式保存，后缀 .a
